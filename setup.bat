@echo off
chcp 65001 >nul
setlocal

pushd "%~dp0"

rem 既存の仮想環境が存在する場合は削除
if exist .venv (
    echo 既存の仮想環境を削除中...
    rmdir /s /q .venv
)

echo.
echo ======================================================================
echo 新しい仮想環境を作成中（Python 3.10）...
echo ======================================================================
uv venv --python 3.10

echo.
echo ======================================================================
echo 仮想環境をアクティベート中...
echo ======================================================================
call .venv\Scripts\activate

echo.
echo ======================================================================
echo pipをインストール中...
echo ======================================================================
uv pip install pip

echo.
echo ======================================================================
echo 依存関係をインストール中（PyTorch CUDA版含む）...
echo ======================================================================
uv pip install -r requirements.txt

echo.
echo ======================================================================
echo Tritonを修正中（Windows互換版に置き換え）...
echo ======================================================================
uv pip uninstall triton
uv pip install "triton-windows<3.6"

echo.
echo ======================================================================
echo セットアップ完了！
echo ======================================================================
echo.
echo 起動するには run.bat を実行してください。
echo.
pause
